<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/default}"
      lang="en">
<head>
    <title>Dashboard - ADRS</title>
    <link rel="stylesheet" th:href="@{/css/map.css}">
    <style>
        .filter-controls {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .filter-button {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--color-border);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .filter-button:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }
        
        .filter-button.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        .data-section {
            display: none;
        }
        
        .data-section.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .stat-card {
            background: var(--color-bg-primary);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--color-border);
            text-align: center;
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-sm);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--color-primary);
            margin: var(--spacing-sm) 0;
        }
        
        .stat-label {
            color: var(--color-text-secondary);
            font-size: 0.875rem;
        }
        
        .data-table {
            width: 100%;
            background: var(--color-bg-primary);
            border-radius: var(--border-radius-md);
            overflow: hidden;
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--color-bg-secondary);
            padding: var(--spacing-md);
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--color-border);
        }
        
        .data-table td {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }
        
        .data-table tr:hover {
            background: var(--color-bg-secondary);
        }
        
        .chart-container {
            background: var(--color-bg-primary);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--color-border);
            margin-bottom: var(--spacing-lg);
        }
        
        .chart-canvas {
            max-height: 400px;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <!-- Welcome Card -->
    <div class="dashboard-card mb-lg">
        <h2 style="margin-bottom: var(--spacing-md);" 
            th:text="'Welcome back, ' + ${#authentication.name} + '!'">
            Welcome back!
        </h2>
        <p style="color: var(--color-text-secondary);" 
           th:text="'You are logged in as ' + ${#strings.replace(#authentication.authorities[0].authority, 'ROLE_', '')}">
            You are logged in as User
        </p>
    </div>

    <!-- Filter Controls -->
    <div class="filter-controls">
        <button class="filter-button active" data-filter="all">📊 Overview</button>
        <button class="filter-button" data-filter="farm-types">🏗️ Farm Types</button>
        <button class="filter-button" data-filter="animal-types">🐮 Animal Types</button>
        <button class="filter-button" data-filter="diseases">🦠 Diseases</button>
        <button class="filter-button" data-filter="users">👥 Users</button>
    </div>

    <!-- Overview Section (Default) -->
    <div id="section-all" class="data-section active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">🏗️</div>
                <div class="stat-value" id="stat-farm-types">-</div>
                <div class="stat-label">Farm Types</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🐮</div>
                <div class="stat-value" id="stat-animal-types">-</div>
                <div class="stat-label">Animal Types</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🦠</div>
                <div class="stat-value" id="stat-diseases">-</div>
                <div class="stat-label">Diseases</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚠️</div>
                <div class="stat-value" id="stat-notifiable">-</div>
                <div class="stat-label">Notifiable Diseases</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">👨‍⚕️</div>
                <div class="stat-value" id="stat-admins">-</div>
                <div class="stat-label">Administrators</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">👨‍🔬</div>
                <div class="stat-value" id="stat-vets">-</div>
                <div class="stat-label">Veterinary Officers</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3 style="margin-bottom: var(--spacing-md);">System Configuration Overview</h3>
            <canvas id="overview-chart" class="chart-canvas"></canvas>
        </div>
    </div>

    <!-- Farm Types Section -->
    <div id="section-farm-types" class="data-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">🏗️</div>
                <div class="stat-value" id="stat-total-farm-types">-</div>
                <div class="stat-label">Total Farm Types</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div class="stat-value" id="stat-active-farm-types">-</div>
                <div class="stat-label">Active Farm Types</div>
            </div>
        </div>
        
        <div class="data-table">
            <h3 style="padding: var(--spacing-lg); margin: 0; background: var(--color-bg-secondary);">
                Farm Types List
            </h3>
            <table id="farm-types-table">
                <thead>
                    <tr>
                        <th>Type Name</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Created Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="4" style="text-align: center; padding: var(--spacing-xl);">
                            Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Animal Types Section -->
    <div id="section-animal-types" class="data-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">🐮</div>
                <div class="stat-value" id="stat-total-animal-types">-</div>
                <div class="stat-label">Total Animal Types</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div class="stat-value" id="stat-active-animal-types">-</div>
                <div class="stat-label">Active Animal Types</div>
            </div>
        </div>
        
        <div class="data-table">
            <h3 style="padding: var(--spacing-lg); margin: 0; background: var(--color-bg-secondary);">
                Animal Types List
            </h3>
            <table id="animal-types-table">
                <thead>
                    <tr>
                        <th>Type Name</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Created Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="4" style="text-align: center; padding: var(--spacing-xl);">
                            Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Diseases Section -->
    <div id="section-diseases" class="data-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">🦠</div>
                <div class="stat-value" id="stat-total-diseases">-</div>
                <div class="stat-label">Total Diseases</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚠️</div>
                <div class="stat-value" id="stat-notifiable-diseases">-</div>
                <div class="stat-label">Notifiable Diseases</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔴</div>
                <div class="stat-value" id="stat-critical-diseases">-</div>
                <div class="stat-label">Critical Severity</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🟠</div>
                <div class="stat-value" id="stat-high-diseases">-</div>
                <div class="stat-label">High Severity</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3 style="margin-bottom: var(--spacing-md);">Disease Severity Distribution</h3>
            <canvas id="disease-chart" class="chart-canvas"></canvas>
        </div>
        
        <div class="data-table">
            <h3 style="padding: var(--spacing-lg); margin: 0; background: var(--color-bg-secondary);">
                Diseases List
            </h3>
            <table id="diseases-table">
                <thead>
                    <tr>
                        <th>Disease Name</th>
                        <th>Severity</th>
                        <th>Notifiable</th>
                        <th>Status</th>
                        <th>Created Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" style="text-align: center; padding: var(--spacing-xl);">
                            Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Users Section -->
    <div id="section-users" class="data-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">👨‍⚕️</div>
                <div class="stat-value" id="stat-admin-count">-</div>
                <div class="stat-label">Administrators</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">👨‍🔬</div>
                <div class="stat-value" id="stat-vet-count">-</div>
                <div class="stat-label">Veterinary Officers</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3 style="margin-bottom: var(--spacing-md);">User Role Distribution</h3>
            <canvas id="users-chart" class="chart-canvas"></canvas>
        </div>

        <!-- Province Map Section -->
        <div class="map-container">
            <h3>User Distribution by Province</h3>
            
            <!-- Role Filter Buttons -->
            <div class="map-filters">
                <button class="map-filter-btn active" data-role="">
                    <span>📊</span> All Users
                </button>
                <button class="map-filter-btn" data-role="ADMIN">
                    <span>👨‍⚕️</span> Administrators
                </button>
                <button class="map-filter-btn" data-role="VETERINARY_OFFICER">
                    <span>👨‍🔬</span> Veterinary Officers
                </button>
            </div>
            
            <!-- Map Loading State -->
            <div id="map-loading" class="map-loading" style="display: none;">
                Loading map data
            </div>
            
            <!-- Map Container -->
            <div id="sri-lanka-map" class="province-map"></div>
            
            <!-- Color Legend -->
            <div class="map-legend">
                <span>Low</span>
                <div class="legend-gradient"></div>
                <span>High</span>
            </div>
        </div>
    </div>

    <!-- Province User List Modal -->
    <div id="province-modal" class="province-modal">
        <div class="province-modal-content">
            <div class="province-modal-header">
                <h3 id="province-modal-title">Province Users</h3>
                <button class="province-modal-close" id="close-province-modal" aria-label="Close">
                    ×
                </button>
            </div>
            <div class="province-modal-body">
                <!-- Stats -->
                <div class="province-modal-stats" id="province-modal-stats"></div>
                
                <!-- Loading State -->
                <div id="province-modal-loading" class="province-modal-loading" style="display: none;">
                    Loading users...
                </div>
                
                <!-- Error State -->
                <div id="province-modal-error" class="province-modal-error" style="display: none;">
                    Failed to load users. Please try again.
                </div>
                
                <!-- User List -->
                <ul id="province-user-list" class="province-user-list"></ul>
            </div>
        </div>
    </div>

    <!-- Raphael.js CDN for SVG map rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script th:src="@{/js/sri-lanka-map.js}"></script>
    <script th:src="@{/js/dashboard.js}"></script>
</div>
</body>
</html>
